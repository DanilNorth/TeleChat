<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleChat</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel для JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Telegram-like Background */
        body {
            background-color: #0f0f0f;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .chat-bg {
            background-image: url("https://web.telegram.org/img/bg_0.png"); 
            background-repeat: repeat;
            background-size: auto;
        }
        .message-own {
            background-color: #8774e1;
            border-bottom-right-radius: 0;
        }
        .message-other {
            background-color: #212121;
            border-bottom-left-radius: 0;
        }
        .reply-preview-border {
            border-left: 2px solid #8774e1;
        }
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // SETTINGS (FILL THESE AFTER CREATING SUPABASE PROJECT)
        // ==========================================
        const SUPABASE_URL = "ТВОЙ_SUPABASE_URL"; 
        const SUPABASE_KEY = "ТВОЙ_SUPABASE_ANON_KEY"; 
        // ==========================================

        const { useState, useEffect, useRef } = React;
        const { createClient } = supabase;

        let supabaseClient = null;
        // Улучшенная логика проверки: инициализируем, если значения изменены
        const isDefault = (val) => val.includes("ТВОЙ_SUPABASE") || val === "";
        
        if (!isDefault(SUPABASE_URL) && !isDefault(SUPABASE_KEY)) {
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        function App() {
            const [session, setSession] = useState(null);
            const [isConfigured, setIsConfigured] = useState(false);

            useEffect(() => {
                if (supabaseClient) {
                    setIsConfigured(true);
                    supabaseClient.auth.getSession().then(({ data: { session } }) => {
                        setSession(session);
                    });

                    const {
                        data: { subscription },
                    } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                        setSession(session);
                    });

                    return () => subscription.unsubscribe();
                } else {
                    setIsConfigured(false);
                }
            }, []);

            if (!isConfigured) {
                return <SetupScreen />;
            }

            return (
                <div className="h-screen w-full flex justify-center bg-black">
                    <div className="w-full max-w-md h-full bg-[#1c1c1c] flex flex-col shadow-2xl overflow-hidden relative">
                        {!session ? (
                            <Auth supabase={supabaseClient} />
                        ) : (
                            <Chat session={session} supabase={supabaseClient} />
                        )}
                    </div>
                </div>
            );
        }

        function SetupScreen() {
            return (
                <div className="h-screen flex items-center justify-center p-4 text-center">
                    <div className="bg-red-900/20 border border-red-500 p-6 rounded-lg max-w-lg">
                        <h1 className="text-2xl font-bold mb-4 text-red-400">Требуется настройка</h1>
                        <p className="mb-4">Пожалуйста, проверьте переменные <code>SUPABASE_URL</code> и <code>SUPABASE_KEY</code> в коде (строки 43-44).</p>
                        <p className="text-sm text-gray-400">Убедитесь, что вы удалили текст "ТВОЙ_SUPABASE_..." и вставили свои ключи из настроек проекта Supabase (Settings -> API).</p>
                    </div>
                </div>
            )
        }

        function Auth({ supabase }) {
            const [loading, setLoading] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                let result;
                try {
                    if (isLogin) {
                        result = await supabase.auth.signInWithPassword({ email, password });
                    } else {
                        result = await supabase.auth.signUp({ email, password });
                    }

                    if (result.error) {
                        setError(result.error.message);
                    }
                } catch (e) {
                    setError("Ошибка сети или неверный URL Supabase");
                }
                setLoading(false);
            };

            return (
                <div className="flex-1 flex flex-col justify-center items-center p-6 bg-[#1c1c1c]">
                    <div className="w-20 h-20 bg-blue-500 rounded-full flex items-center justify-center mb-6 shadow-lg">
                        <i data-lucide="send" className="w-10 h-10 text-white ml-[-4px]"></i>
                    </div>
                    <h2 className="text-2xl font-bold mb-6">{isLogin ? 'Вход в TeleChat' : 'Регистрация'}</h2>
                    
                    <form onSubmit={handleAuth} className="w-full space-y-4">
                        <input
                            type="email"
                            placeholder="Email"
                            className="w-full p-3 bg-[#2c2c2c] rounded-xl border border-transparent focus:border-blue-500 outline-none transition text-white"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                        />
                        <input
                            type="password"
                            placeholder="Пароль"
                            className="w-full p-3 bg-[#2c2c2c] rounded-xl border border-transparent focus:border-blue-500 outline-none transition text-white"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                        />
                        {error && <p className="text-red-400 text-sm text-center">{error}</p>}
                        
                        <button 
                            disabled={loading}
                            className="w-full py-3 bg-[#8774e1] hover:bg-[#6f5ec2] rounded-xl font-bold transition disabled:opacity-50"
                        >
                            {loading ? 'Загрузка...' : (isLogin ? 'Войти' : 'Создать аккаунт')}
                        </button>
                    </form>

                    <button 
                        onClick={() => setIsLogin(!isLogin)}
                        className="mt-6 text-blue-400 hover:text-blue-300 text-sm"
                    >
                        {isLogin ? 'Нет аккаунта? Зарегистрироваться' : 'Есть аккаунт? Войти'}
                    </button>
                </div>
            );
        }

        function Chat({ session, supabase }) {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [replyTo, setReplyTo] = useState(null);
            const [isSending, setIsSending] = useState(false);
            const messagesEndRef = useRef(null);

            const getUsername = (email) => email ? email.split('@')[0] : 'User';

            useEffect(() => {
                const fetchMessages = async () => {
                    const { data, error } = await supabase
                        .from('messages')
                        .select('*')
                        .order('created_at', { ascending: true })
                        .limit(100);
                    
                    if (error) console.error("Error fetching messages:", error);
                    if (data) setMessages(data);
                };

                fetchMessages();

                const channel = supabase
                    .channel('public:messages')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                        setMessages((prev) => {
                            if (prev.find(msg => msg.id === payload.new.id)) return prev;
                            return [...prev, payload.new];
                        });
                    })
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, [supabase]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || isSending) return;

                setIsSending(true);
                const content = newMessage;
                const rToId = replyTo ? replyTo.id : null;
                
                setNewMessage('');
                const lastReplyTo = replyTo;
                setReplyTo(null);

                try {
                    const { data, error } = await supabase
                        .from('messages')
                        .insert({
                            user_id: session.user.id,
                            email: session.user.email,
                            content: content,
                            reply_to_id: rToId
                        })
                        .select();

                    if (error) {
                        console.error('Full Send Error Object:', error);
                        setNewMessage(content);
                        setReplyTo(lastReplyTo);
                        alert("Ошибка при отправке: " + error.message);
                    } else if (data && data[0]) {
                        setMessages((prev) => {
                             if (prev.find(msg => msg.id === data[0].id)) return prev;
                             return [...prev, data[0]];
                        });
                    }
                } catch (err) {
                    console.error("Unexpected error:", err);
                } finally {
                    setIsSending(false);
                }
            };

            const formatTime = (isoString) => {
                const date = new Date(isoString);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            const findOriginalMessage = (id) => messages.find(m => m.id === id);

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <div className="h-14 bg-[#212121] flex items-center justify-between px-4 shadow-md z-10 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-[#8774e1] rounded-full flex items-center justify-center text-xs font-bold">OC</div>
                            <div className="font-bold text-lg">Общий чат</div>
                        </div>
                        <button onClick={() => supabase.auth.signOut()} className="text-gray-400 hover:text-white text-sm">
                            Выйти
                        </button>
                    </div>

                    {/* Messages Area */}
                    <div className="flex-1 overflow-y-auto p-4 chat-bg relative">
                        <div className="absolute inset-0 bg-black/40 pointer-events-none"></div>
                        <div className="relative z-10 space-y-3">
                            {messages.map((msg) => {
                                const isOwn = msg.user_id === session.user.id;
                                const original = msg.reply_to_id ? findOriginalMessage(msg.reply_to_id) : null;
                                
                                return (
                                    <div 
                                        key={msg.id} 
                                        className={`flex w-full ${isOwn ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div 
                                            className={`max-w-[85%] px-3 py-2 rounded-2xl relative shadow-md text-sm cursor-pointer transition active:scale-95 ${isOwn ? 'message-own' : 'message-other'}`}
                                            onClick={() => setReplyTo(msg)}
                                        >
                                            {!isOwn && (
                                                <div className="text-xs text-[#8774e1] font-bold mb-1">
                                                    {getUsername(msg.email)}
                                                </div>
                                            )}

                                            {original && (
                                                <div className="bg-black/20 rounded-lg p-2 mb-2 reply-preview-border text-xs opacity-80 border-l-2">
                                                    <div className="font-bold text-[#8774e1]">
                                                        {getUsername(original.email)}
                                                    </div>
                                                    <div className="truncate italic">
                                                        {original.content}
                                                    </div>
                                                </div>
                                            )}

                                            <div className="break-words text-white leading-tight">{msg.content}</div>
                                            <div className="text-[10px] text-gray-300 text-right mt-1 opacity-70">
                                                {formatTime(msg.created_at)}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    {/* Input & Reply Preview */}
                    <div className="bg-[#212121] shrink-0">
                        {replyTo && (
                            <div className="px-4 py-2 flex items-center justify-between border-b border-gray-800 animate-slide-up">
                                <div className="flex items-center gap-3 overflow-hidden">
                                    <div className="w-1 h-8 bg-[#8774e1] rounded-full"></div>
                                    <div className="text-xs truncate">
                                        <div className="text-[#8774e1] font-bold">Ответ пользователю {getUsername(replyTo.email)}</div>
                                        <div className="text-gray-400 truncate">{replyTo.content}</div>
                                    </div>
                                </div>
                                <button onClick={() => setReplyTo(null)} className="text-gray-400 hover:text-white">
                                    <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                            </div>
                        )}
                        <form onSubmit={sendMessage} className="p-2 flex items-end gap-2">
                            <input
                                type="text"
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                placeholder="Написать сообщение..."
                                disabled={isSending}
                                className="flex-1 bg-black/20 text-white rounded-xl px-4 py-3 outline-none focus:ring-1 focus:ring-[#8774e1] transition disabled:opacity-50"
                            />
                            <button 
                                type="submit"
                                disabled={isSending}
                                className="w-12 h-12 flex items-center justify-center bg-[#8774e1] hover:bg-[#6f5ec2] rounded-full transition text-white shadow-lg shrink-0 disabled:opacity-50"
                            >
                                <i data-lucide="send-horizontal" className="w-6 h-6"></i>
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Refresh icons whenever the DOM updates
        const observer = new MutationObserver(() => {
            if (window.lucide) window.lucide.createIcons();
        });
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
